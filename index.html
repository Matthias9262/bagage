<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Scanner RA Bagage + IA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.148.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.148.0/examples/jsm/webxr/ARButton.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      font-size: 16px;
      z-index: 1;
      border-radius: 8px;
    }
    #reset {
      background: #007aff;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      font-size: 16px;
      margin-top: 10px;
    }
    video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -1;
    }
  </style>
</head>
<body>
  <video id="video" autoplay muted playsinline></video>
  <div id="info">
    <div id="status">üéØ Touchez deux coins du bagage pour mesurer üìè</div>
    <div id="type">üîé Type : analyse en cours...</div>
    <button id="reset">R√©initialiser</button>
  </div>

  <script>
    let camera, scene, renderer;
    let controller;
    let hitTestSource = null;
    let hitTestSourceRequested = false;
    const points = [];

    const statusEl = document.getElementById("status");
    const typeEl = document.getElementById("type");
    const resetBtn = document.getElementById("reset");
    const video = document.getElementById("video");

    async function initVideoAndModel() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
      const model = await cocoSsd.load();
      detect(model);
    }

    async function detect(model) {
      const detectLoop = async () => {
        const predictions = await model.detect(video);
        const bag = predictions.find(p => ['suitcase', 'backpack', 'handbag'].includes(p.class) && p.score > 0.6);
        if (bag) {
          typeEl.innerHTML = `üß≥ Objet d√©tect√© : <strong>${bag.class}</strong> (${(bag.score * 100).toFixed(0)}%)`;
        } else {
          typeEl.textContent = "üîé Aucun bagage d√©tect√© pour l‚Äôinstant...";
        }
        requestAnimationFrame(() => detect(model));
      };
      detectLoop();
    }

    function initXR() {
      const container = document.createElement('div');
      document.body.appendChild(container);

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      container.appendChild(renderer.domElement);

      document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

      controller = renderer.xr.getController(0);
      controller.addEventListener('select', onSelect);
      scene.add(controller);

      resetBtn.addEventListener("click", () => {
        points.length = 0;
        while (scene.children.length > 1) scene.remove(scene.children[1]);
        statusEl.textContent = "Touchez deux coins du bagage pour mesurer üìè";
      });

      renderer.setAnimationLoop(render);
    }

    function onSelect() {
      if (!hitTestSource) return;
      const frame = renderer.xr.getFrame();
      const referenceSpace = renderer.xr.getReferenceSpace();
      const viewerPose = frame.getViewerPose(referenceSpace);

      if (viewerPose && hitTestSource) {
        const hitTestResults = frame.getHitTestResults(hitTestSource);
        if (hitTestResults.length > 0) {
          const hit = hitTestResults[0];
          const pose = hit.getPose(referenceSpace);

          const pt = new THREE.Vector3().fromArray(pose.transform.position.toArray());
          const marker = new THREE.Mesh(
            new THREE.SphereGeometry(0.01, 16, 16),
            new THREE.MeshBasicMaterial({ color: 0xff0000 })
          );
          marker.position.copy(pt);
          scene.add(marker);
          points.push(pt);

          if (points.length === 2) {
            const dist = points[0].distanceTo(points[1]);
            const cm = (dist * 100).toFixed(1);
            const ok = cm <= 55;
            statusEl.innerHTML = `üìê Distance : <strong>${cm} cm</strong><br>${ok ? '‚úÖ Bagage conforme OUIGO' : '‚ùå Trop grand pour OUIGO'}`;
          }
        }
      }
    }

    function render(timestamp, frame) {
      if (frame) {
        const session = renderer.xr.getSession();
        if (!hitTestSourceRequested) {
          session.requestReferenceSpace('viewer').then((referenceSpace) => {
            session.requestHitTestSource({ space: referenceSpace }).then((source) => {
              hitTestSource = source;
            });
          });
          hitTestSourceRequested = true;
        }
      }
      renderer.render(scene, camera);
    }

    initVideoAndModel();
    initXR();
  </script>
</body>
</html>
