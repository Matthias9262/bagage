<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Détection bagage IA - Version fonctionnelle</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f0f0;
    margin: 20px;
    text-align: center;
  }
  #video-container {
    position: relative;
    display: inline-block;
  }
  video, canvas {
    border-radius: 10px;
    width: 640px;
    height: 480px;
  }
  canvas {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
  }
  #status {
    margin-top: 10px;
    font-weight: bold;
  }
  #detections {
    max-width: 640px;
    margin: 10px auto;
    background: white;
    padding: 10px;
    border-radius: 8px;
    height: 120px;
    overflow-y: auto;
    text-align: left;
  }
</style>
</head>
<body>

<h1>Détection Bagage IA</h1>

<div>
  <select id="cameraSelect"></select>
  <button id="startBtn">Démarrer caméra</button>
</div>

<div id="video-container">
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>
</div>

<div id="status">Modèle non chargé</div>
<div id="detections"></div>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const status = document.getElementById('status');
  const detectionsDiv = document.getElementById('detections');
  const cameraSelect = document.getElementById('cameraSelect');
  const startBtn = document.getElementById('startBtn');

  let model;
  let stream;
  let detectionInterval;
  const bagClasses = ['suitcase', 'backpack', 'handbag'];
  const confidenceThreshold = 0.5;

  async function setupCameras() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(d => d.kind === 'videoinput');
    cameraSelect.innerHTML = '';
    videoDevices.forEach((device, i) => {
      const option = document.createElement('option');
      option.value = device.deviceId;
      option.text = device.label || `Caméra ${i + 1}`;
      cameraSelect.appendChild(option);
    });
  }

  async function startCamera() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: cameraSelect.value ? { exact: cameraSelect.value } : undefined }
      });
      video.srcObject = stream;
      await new Promise(resolve => (video.onloadedmetadata = resolve));
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
    } catch (err) {
      alert('Erreur accès caméra : ' + err.message);
    }
  }

  async function loadModel() {
    status.textContent = 'Chargement du modèle...';
    model = await cocoSsd.load();
    status.textContent = 'Modèle chargé ✅';
  }

  function drawTemplate() {
    const maxWidth = 300;
    const maxHeight = 400;
    const x = (canvas.width - maxWidth) / 2;
    const y = (canvas.height - maxHeight) / 2;
    ctx.save();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = '#1a73e8';
    ctx.lineWidth = 3;
    ctx.setLineDash([10,5]);
    ctx.strokeRect(x, y, maxWidth, maxHeight);
    ctx.font = '16px Arial';
    ctx.fillStyle = '#1a73e8';
    ctx.fillText('Taille max autorisée', x + 10, y - 10);
    ctx.restore();
  }

  async function detect() {
    if (!model) return;
    drawTemplate();

    const predictions = await model.detect(video);
    drawTemplate();

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawTemplate();

    let detectedBags = predictions.filter(p => bagClasses.includes(p.class) && p.score > confidenceThreshold);

    detectionsDiv.innerHTML = '';

    detectedBags.forEach(pred => {
      const [x, y, w, h] = pred.bbox;
      const maxWidthAllowed = 300;
      const maxHeightAllowed = 400;
      const isValid = w <= maxWidthAllowed && h <= maxHeightAllowed;

      ctx.strokeStyle = isValid ? 'limegreen' : 'red';
      ctx.lineWidth = 4;
      ctx.strokeRect(x, y, w, h);
      ctx.font = '18px Arial';
      ctx.fillStyle = isValid ? 'limegreen' : 'red';
      ctx.fillText(`${pred.class} ${(pred.score*100).toFixed(1)}%`, x, y > 20 ? y - 5 : y + 20);

      detectionsDiv.innerHTML += `<div style="color:${isValid ? 'green' : 'red'}">
        ${pred.class} - Confiance : ${(pred.score*100).toFixed(1)}% - Taille: ${Math.round(w)}x${Math.round(h)} - ${isValid ? '✅ OK' : '❌ Trop grand'}
      </div>`;
    });
  }

  startBtn.onclick = async () => {
    startBtn.disabled = true;
    await startCamera();
    if (!model) {
      await loadModel();
    }
    status.textContent = 'Détection en cours...';

    if (detectionInterval) clearInterval(detectionInterval);
    detectionInterval = setInterval(detect, 200); // 5fps

    startBtn.disabled = false;
  };

  window.onload = () => {
    setupCameras();
  };
</script>

</body>
</html>
