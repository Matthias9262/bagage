<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>D√©mo Bagage RA OUIGO Am√©lior√©e</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
<style>
  body {
    margin: 0; background: #111; color: #eee; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh;
    user-select: none;
    padding: 10px 0 40px 0;
    position: relative;
  }
  #video {
    width: 100vw; max-width: 480px; height: auto; border-radius: 12px; object-fit: cover; background: black;
    position: relative; z-index: 1;
  }
  #bboxCanvas {
    position: absolute; top: 0; left: 50%; transform: translateX(-50%);
    max-width: 480px; width: 100vw; height: auto;
    pointer-events: none; z-index: 2;
  }
  #calibration-box {
    position: absolute;
    border: 3px dashed #E6007E; /* OUIGO rose vif */
    border-radius: 10px;
    width: 85mm; /* largeur carte bancaire */
    height: 54mm; /* hauteur carte bancaire */
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    box-sizing: border-box;
    animation: pulseOUIGO 2s ease-in-out infinite;
    pointer-events: none;
    z-index: 3;
  }
  @keyframes pulseOUIGO {
    0%, 100% { box-shadow: 0 0 12px 4px #E6007E88; }
    50% { box-shadow: 0 0 24px 8px #FF3FA688; }
  }
  #overlay {
    position: relative;
    margin-top: 15px;
    width: 90vw; max-width: 480px;
    background: rgba(230, 0, 126, 0.85);
    padding: 12px 20px;
    border-radius: 12px;
    font-size: 18px;
    user-select: none;
    text-align: center;
    font-weight: 600;
    box-shadow: 0 0 8px #E6007EAA;
  }
  #btnStart, #btnReset {
    margin-top: 15px;
    padding: 14px 36px;
    font-size: 20px;
    font-weight: 700;
    border-radius: 40px;
    border: none;
    background: #FF3FA6;
    color: #fff;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s ease;
    box-shadow: 0 0 10px #FF3FA6AA;
  }
  #btnStart:hover, #btnReset:hover {
    background: #E6007E;
  }
  #confidenceBar {
    width: 100%;
    height: 14px;
    background: #333;
    border-radius: 7px;
    margin-top: 6px;
    overflow: hidden;
    box-shadow: inset 0 0 5px #000;
  }
  #confidenceFill {
    height: 100%;
    width: 0%;
    background: #0f0;
    border-radius: 7px 0 0 7px;
    transition: width 0.2s ease-out;
  }
  #messageStatus {
    margin-top: 8px;
    font-size: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  #messageStatus svg {
    width: 28px;
    height: 28px;
  }
  #countdown {
    font-weight: 700;
    font-size: 20px;
    margin-top: 8px;
    color: #fff;
  }
  #logoOuigo {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 100px;
    opacity: 0.15;
    user-select: none;
    pointer-events: none;
    z-index: 1000;
  }
</style>
</head>
<body>

  <img id="logoOuigo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fd/OUIGO_logo_2019.svg/2560px-OUIGO_logo_2019.svg.png" alt="Logo OUIGO" />

  <video id="video" autoplay muted playsinline></video>
  <canvas id="bboxCanvas"></canvas>
  <div id="calibration-box"></div>

  <div id="overlay">
    <div id="instructions">Place ta carte bancaire dans le cadre rose pendant <span id="countdown">5</span> secondes pour calibrer üìè</div>
    <div id="typeDetection"></div>
    <div id="confidenceBar"><div id="confidenceFill"></div></div>
    <div id="messageStatus"></div>
    <button id="btnStart">D√©marrer la d√©mo automatique</button>
    <button id="btnReset" style="display:none;">Recalibrer</button>
  </div>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('bboxCanvas');
  const ctx = canvas.getContext('2d');
  const calibrationBox = document.getElementById('calibration-box');
  const btnStart = document.getElementById('btnStart');
  const btnReset = document.getElementById('btnReset');
  const instructions = document.getElementById('instructions');
  const countdownEl = document.getElementById('countdown');
  const typeDetection = document.getElementById('typeDetection');
  const confidenceFill = document.getElementById('confidenceFill');
  const messageStatus = document.getElementById('messageStatus');

  let model = null;
  let isCalibrated = false;
  let calibrationPxWidth = 0;
  const realCardWidthCm = 8.5; // largeur carte bancaire en cm
  let scalePxToCm = 0;

  // Pour stabiliser bbox
  let bboxHistory = [];
  let detectionStableCount = 0;
  const stableThreshold = 4; // frames cons√©cutives n√©cessaires

  let captureDone = false;
  let countdownInterval = null;

  function adjustCanvas() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.style.width = video.clientWidth + 'px';
    canvas.style.height = video.clientHeight + 'px';
  }

  async function setupCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
    video.srcObject = stream;
    return new Promise(resolve => {
      video.onloadedmetadata = () => {
        adjustCanvas();
        resolve();
      };
    });
  }

  async function loadModel() {
    model = await cocoSsd.load();
  }

  function calibrate() {
    const rect = calibrationBox.getBoundingClientRect();
    const videoRect = video.getBoundingClientRect();
    calibrationPxWidth = rect.width * (video.videoWidth / videoRect.width);
    scalePxToCm = realCardWidthCm / calibrationPxWidth;
    isCalibrated = true;
    instructions.textContent = "‚úÖ Calibration termin√©e, approche un bagage devant la cam√©ra...";
    calibrationBox.style.display = 'none';
    btnReset.style.display = 'inline-block';
  }

  function speak(text) {
    if (!window.speechSynthesis) return;

    window.speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'fr-FR';

    const voices = window.speechSynthesis.getVoices();

    function selectVoice() {
      let voice = voices.find(v => v.lang.startsWith('fr') && /female|femme|f/gi.test(v.name));
      if (!voice) {
        voice = voices.find(v => v.lang.startsWith('fr'));
      }
      return voice || null;
    }

    let voice = selectVoice();

    if (voice) {
      utter.voice = voice;
      utter.pitch = 1.1;
      utter.rate = 0.9;
    }

    if (voices.length === 0) {
      window.speechSynthesis.onvoiceschanged = () => {
        const voicesUpdated = window.speechSynthesis.getVoices();
        utter.voice = voicesUpdated.length ? selectVoice() : null;
        window.speechSynthesis.speak(utter);
      };
    } else {
      window.speechSynthesis.speak(utter);
    }
  }

  function drawBBox(bbox, ok) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.lineWidth = 5;
    ctx.strokeStyle = ok ? '#E6007E' : '#FF3FA6';
    ctx.fillStyle = ok ? 'rgba(230,0,126,0.3)' : 'rgba(255,63,166,0.3)';
    ctx.font = "26px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    ctx.fillRect(bbox[0], bbox[1], bbox[2], bbox[3]);
    ctx.strokeRect(bbox[0], bbox[1], bbox[2], bbox[3]);
  }

  function pulseCanvasColor(ok) {
    // Animation pulse simple en changeant la couleur de bordure du canvas
    const colorStart = ok ? '#E6007E' : '#FF3FA6';
    const pulseDuration = 1000;
    let startTime = null;

    function animate(timestamp) {
      if (!startTime) startTime = timestamp;
      let progress = (timestamp - startTime) / pulseDuration;
      if (progress > 1) progress = 1;
      const alpha = 0.4 + 0.6 * Math.abs(Math.sin(progress * Math.PI * 2));
      ctx.strokeStyle = ok ? `rgba(230,0,126,${alpha.toFixed(2)})` : `rgba(255,63,166,${alpha.toFixed(2)})`;
      ctx.lineWidth = 6;
      ctx.strokeRect(lastSmoothBBox[0], lastSmoothBBox[1], lastSmoothBBox[2], lastSmoothBBox[3]);
      if (progress < 1) {
        requestAnimationFrame(animate);
      }
    }
    requestAnimationFrame(animate);
  }

  let lastSmoothBBox = null;

  function smoothBBox(newBBox) {
    bboxHistory.push(newBBox);
    if (bboxHistory.length > 5) bboxHistory.shift();

    let avgBBox = [0, 0, 0, 0];
    for (const box of bboxHistory) {
      avgBBox[0] += box[0];
      avgBBox[1] += box[1];
      avgBBox[2] += box[2];
      avgBBox[3] += box[3];
    }
    avgBBox = avgBBox.map(x => x / bboxHistory.length);
    lastSmoothBBox = avgBBox;
    return avgBBox;
  }

  function setConfidenceBar(score) {
    const percent = Math.min(1, Math.max(0, score)) * 100;
    confidenceFill.style.width = percent + '%';
    confidenceFill.style.background = percent > 0.7 ? '#00ff66' : percent > 0.4 ? '#ffcc00' : '#ff3300';
  }

  function setMessageStatus(ok) {
    if(ok) {
      messageStatus.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="#00ff66" viewBox="0 0 24 24"><path d="M9 16.17l-3.59-3.58L4 14l5 5 12-12-1.41-1.42z"/></svg>
        Bagage conforme OUIGO !
      `;
    } else {
      messageStatus.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="#ff3300" viewBox="0 0 24 24"><path d="M18.3 5.71L12 12l6.3 6.29-1.42 1.42L10.59 13.4 4.3 19.7 2.88 18.29 9.17 12 2.88 5.71 4.3 4.29 10.59 10.58 16.88 4.29z"/></svg>
        Bagage trop grand !
      `;
    }
  }

  async function detectLoop() {
    if (!model) return;
    const predictions = await model.detect(video);
    // Ajouter un objet 'sports bag' pour exemple (non dans COCO-SSD officiel)
    // Pour d√©mo on reste sur suitcase, backpack, handbag
    const bagClasses = ['suitcase', 'backpack', 'handbag']; 
    const bag = predictions.find(p => bagClasses.includes(p.class) && p.score > 0.85);

    if (bag && isCalibrated) {
      detectionStableCount++;
      bboxHistory.push(bag.bbox);
      if (bboxHistory.length > 5) bboxHistory.shift();

      setConfidenceBar(bag.score);

      if (detectionStableCount >= stableThreshold) {
        const smoothBox = smoothBBox(bboxHistory);
        drawBBox(smoothBox, true);

        typeDetection.textContent = `üß≥ Objet d√©tect√© : ${bag.class} (${(bag.score*100).toFixed(0)}%)`;

        const bboxPxWidth = smoothBox[2];
        const bboxCmWidth = bboxPxWidth * scalePxToCm;
        const maxWidthCm = 55;
        const ok = bboxCmWidth <= maxWidthCm;

        sizeResult.textContent = `Largeur estim√©e : ${bboxCmWidth.toFixed(1)} cm ‚Äî ${ok ? '‚úÖ Conforme OUIGO' : '‚ùå Trop large'}`;
        setMessageStatus(ok);

        if (!captureDone && ok) {
          speak("Super, votre bagage est OK pour OUIGO ! Et si vous en avez plus, pensez √† l‚Äôoption bagage suppl√©mentaire, histoire d‚Äô√©viter les surprises !");
          captureDone = true;
          setTimeout(() => { captureDone = false; }, 10000);
        } else if (!captureDone && !ok) {
          speak("Attention, votre bagage est trop grand pour OUIGO");
          captureDone = true;
          setTimeout(() => { captureDone = false; }, 10000);
        }
      }
    } else {
      detectionStableCount = 0;
      bboxHistory = [];
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      confidenceFill.style.width = '0%';
      typeDetection.textContent = "üîé Aucun bagage d√©tect√©...";
      sizeResult.textContent = "";
      messageStatus.innerHTML = "";
    }
    requestAnimationFrame(detectLoop);
  }

  function startCalibrationCountdown(duration = 5) {
    let timeLeft = duration;
    countdownEl.textContent = timeLeft;
    calibrationBox.style.display = 'block';
    instructions.textContent = `Place
