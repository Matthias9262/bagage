<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>D√©tection Bagage IA - D√©mo Optimis√©e</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <style>
    /* Reset & basics */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: #f4f7fb;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    h1 {
      margin-bottom: 0.3em;
      color: #1a73e8;
      font-weight: 700;
      text-align: center;
    }

    /* Container */
    #container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(26, 115, 232, 0.15);
      max-width: 720px;
      width: 100%;
      padding: 20px 30px 30px 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Controls */
    #controls {
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 1em;
      margin-bottom: 20px;
    }
    select, button {
      padding: 10px 16px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1.5px solid #ddd;
      outline-offset: 2px;
      transition: all 0.2s ease;
      cursor: pointer;
      min-width: 150px;
      background: white;
    }
    select:focus, button:focus {
      border-color: #1a73e8;
      box-shadow: 0 0 6px #1a73e8aa;
    }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      font-weight: 600;
    }
    button:hover:not(:disabled) {
      background: #155ab6;
    }
    button:disabled {
      background: #aac5f9;
      cursor: not-allowed;
    }

    /* Video and canvas wrapper */
    #wrapper {
      position: relative;
      width: 640px;
      max-width: 90vw;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 4px 18px rgba(0,0,0,0.1);
      background: black;
    }
    video, canvas {
      display: block;
      width: 100%;
      height: auto;
    }
    canvas {
      position: absolute;
      top: 0; left: 0;
      pointer-events: none;
    }

    /* Status */
    #status {
      margin-top: 15px;
      font-size: 1.25rem;
      font-weight: 600;
      min-height: 1.5em;
      color: #444;
    }

    /* Detections list */
    #detectionsList {
      margin-top: 20px;
      width: 100%;
      max-height: 160px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px 18px;
      background: #f9fbff;
      font-size: 1rem;
      color: #222;
      box-shadow: inset 0 0 5px #d0d8e6;
      line-height: 1.4;
    }
    #detectionsList div {
      margin-bottom: 8px;
      font-weight: 600;
      padding-bottom: 4px;
      border-bottom: 1px solid #e2e8f0;
    }
    #detectionsList div:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    /* Snapshot */
    #snapshot {
      margin-top: 20px;
      width: 320px;
      max-width: 90vw;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(26, 115, 232, 0.3);
      border: 3px solid #1a73e8;
      background: white;
      display: none;
    }

    /* Scrollbar detection list */
    #detectionsList::-webkit-scrollbar {
      width: 8px;
    }
    #detectionsList::-webkit-scrollbar-thumb {
      background: #a0b9f9;
      border-radius: 4px;
    }

  </style>
</head>
<body>
  <h1>üß≥ D√©tection Bagage IA - D√©mo Optimis√©e</h1>
  <div id="container">
    <div id="controls">
      <select id="cameraSelect" aria-label="Choisir cam√©ra"></select>
      <button id="startButton">D√©marrer la cam√©ra</button>
    </div>

    <div id="wrapper">
      <video id="webcam" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>
    </div>

    <div id="status">Mod√®le non charg√©</div>

    <div id="detectionsList" aria-live="polite" aria-atomic="true"></div>

    <img id="snapshot" alt="Capture automatique" />
  </div>

  <script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const statusDiv = document.getElementById('status');
    const detectionsList = document.getElementById('detectionsList');
    const snapshotImg = document.getElementById('snapshot');
    const cameraSelect = document.getElementById('cameraSelect');
    const startButton = document.getElementById('startButton');

    let model = null;
    let detectRunning = false;
    let lastCaptured = 0;
    const captureCooldown = 5000; // 5 secondes entre captures
    const bagClasses = ['suitcase', 'backpack', 'handbag'];
    const confidenceThreshold = 0.5;

    const classTranslations = {
      'suitcase': 'valise',
      'backpack': 'sac √† dos',
      'handbag': 'sac √† main',
    };

    let stream = null;

    // Stockage des scores pour moyenne glissante (cl√©: objet d√©tect√©, valeur: tableau des scores)
    const detectionHistory = {};

    // Fonction pour g√©n√©rer une cl√© unique pour un objet d√©tect√© (classe + position arrondie)
    function getDetectionKey(detection) {
      const x = Math.round(detection.bbox[0] / 20);
      const y = Math.round(detection.bbox[1] / 20);
      return `${detection.class}_${x}_${y}`;
    }

    // Gabarit visuel : taille max autoris√©e en pixels (ajuste selon besoin)
    const maxWidthAllowed = 300;  // largeur max en px
    const maxHeightAllowed = 400; // hauteur max en px

    async function listCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        cameraSelect.innerHTML = '';
        videoDevices.forEach((device, i) => {
          const option = document.createElement('option');
          option.value = device.deviceId;
          option.text = device.label || `Cam√©ra ${i + 1}`;
          cameraSelect.appendChild(option);
        });
      } catch (e) {
        alert('Erreur lors de la r√©cup√©ration des cam√©ras : ' + e.message);
      }
    }

    async function startCamera(deviceId) {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: deviceId ? { exact: deviceId } : undefined }
        });
        video.srcObject = stream;
        await new Promise(resolve => (video.onloadedmetadata = resolve));
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
      } catch (e) {
        alert('Erreur lors de l\'acc√®s √† la cam√©ra : ' + e.message);
      }
    }

    async function loadModel() {
      statusDiv.innerText = 'Chargement du mod√®le...';
      model = await cocoSsd.load();
      statusDiv.innerText = 'Mod√®le charg√© ‚úÖ';
      startButton.disabled = false;
    }

    function drawTemplate() {
      // cadre semi-transparent au centre pour taille max autoris√©e
      const x = (canvas.width - maxWidthAllowed) / 2;
      const y = (canvas.height - maxHeightAllowed) / 2;
      ctx.save();
      ctx.strokeStyle = '#1a73e8';
      ctx.lineWidth = 3;
      ctx.setLineDash([12, 6]);
      ctx.strokeRect(x, y, maxWidthAllowed, maxHeightAllowed);
      ctx.restore();

      ctx.save();
      ctx.font = '16px "Segoe UI", Tahoma, Geneva, Verdana, sans-serif';
      ctx.fillStyle = '#1a73e8';
      ctx.fillText('Taille max autoris√©e', x + 12, y - 12);
      ctx.restore();
    }

    async function detect() {
      if (!model) return;
      detectRunning = true;

      async function frame() {
        if (!detectRunning) return;

        const predictions = await model.detect(video);
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        drawTemplate();

        // Filtrage par classe et seuil confiance
        const detectedBagsRaw = predictions.filter(p => bagClasses.includes(p.class) && p.score > confidenceThreshold);

        // Mise √† jour detectionHistory + moyenne glissante
        const detectedBags = detectedBagsRaw.map(detection => {
          const key = getDetectionKey(detection);
          if (!detectionHistory[key]) detectionHistory[key] = [];
          detectionHistory[key].push(detection.score);
          if (detectionHistory[key].length > 5) detectionHistory[key].shift();

          const avgScore = detectionHistory[key].reduce((a, b) => a + b, 0) / detectionHistory[key].length;
          return { ...detection, avgScore };
        });

        if (detectedBags.length > 0) {
          // V√©rification taille bbox vs max autoris√©e
          let validCount = 0;
          let invalidCount = 0;

          detectionsList.innerHTML = '';

          detectedBags.forEach(p => {
            const [x, y, width, height] = p.bbox;

            // V√©rifier si bagage dans le cadre max autoris√©
            const isValid = width <= maxWidthAllowed && height <= maxHeightAllowed;

            if (isValid) validCount++; else invalidCount++;

            // Couleur selon validit√© et confiance
            let color = '#d93025'; // rouge Google red
            if (isValid && p.avgScore > 0.75) color = '#188038'; // vert Google green
            else if (isValid) color = '#fbbc04'; // orange Google yellow

            // Dessiner bbox
            ctx.lineWidth = 4;
            ctx.strokeStyle = color;
            ctx.font = '18px "Segoe UI", Tahoma, Geneva, Verdana, sans-serif';
            ctx.fillStyle = color;
            ctx.strokeRect(x, y, width, height);
            ctx.fillText(
              `${classTranslations[p.class] || p.class} ${(p.avgScore * 100).toFixed(1)}%`,
              x,
              y > 20 ? y - 5 : y + 20
            );

            // Ajouter au listing texte
            detectionsList.innerHTML += `<div style="color:${color}">
              ${classTranslations[p.class] || p.class} ‚Äî Confiance : ${(p.avgScore * 100).toFixed(1)}% ‚Äî 
              Taille : ${Math.round(width)}√ó${Math.round(height)} px ‚Äî 
              ${isValid ? '‚úÖ Taille OK' : '‚ùå Trop grand'}
              </div>`;
          });

          statusDiv.innerHTML = `üß≥ Bagages d√©tect√©s : <span style="color:#188038">${validCount}</span> valides, <span style="color:#d93025">${invalidCount}</span> non valides`;

          // Capture automatique si au moins un bagage valide d√©tect√©
          const now = Date.now();
          if (validCount > 0 && now - lastCaptured > captureCooldown) {
            captureSnapshot();
            lastCaptured = now;
            snapshotImg.style.display = 'block';
          }

        } else {
          statusDiv.innerHTML = `üîç <span style="color: #666">Aucun bagage d√©tect√©</span>`;
          detectionsList.innerHTML = '';
          snapshotImg.src = '';
          snapshotImg.style.display = 'none';
        }

        requestAnimationFrame(frame);
      }

      frame();
    }

    function captureSnapshot() {
      const snapshotCanvas = document.createElement('canvas');
      snapshotCanvas.width = video.videoWidth;
      snapshotCanvas.height = video.videoHeight;
      const snapshotCtx = snapshotCanvas.getContext('2d');
      snapshotCtx.drawImage(video, 0, 0, snapshotCanvas.width, snapshotCanvas.height);
      snapshotImg.src = snapshotCanvas.toDataURL('image/png');
    }

    startButton.onclick = async () => {
      detectRunning = false; // stop detection if running
      startButton.disabled = true;
      await startCamera(cameraSelect.value);
      if (!model) await loadModel();
      detect();
      startButton.disabled = false;
    };

    // Initialisation : liste des cam√©ras au chargement
    window.addEventListener('load', () => {
      startButton.disabled = true;
      listCameras().then(() => {
        startButton.disabled = false;
      });
      loadModel();
    });

  </script>
</body>
</html>
