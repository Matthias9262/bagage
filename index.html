async function detectFrame() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const a4Rect = estimateWhiteRectangle(imageData);

  if (a4Rect) {
    ctx.strokeStyle = "blue";
    ctx.lineWidth = 2;
    ctx.strokeRect(a4Rect.x, a4Rect.y, a4Rect.width, a4Rect.height);
    ctx.font = "14px Arial";
    ctx.fillStyle = "blue";
    ctx.fillText("Référence A4", a4Rect.x, a4Rect.y - 5);

    pixelPerCm = a4Rect.width / A4_WIDTH_CM;
  } else {
    pixelPerCm = null;
    ctx.font = "16px Arial";
    ctx.fillStyle = "gray";
    ctx.fillText("🕵️‍♂️ A4 non détectée", 10, 20);
  }

  const predictions = await model.detect(video);
  let foundBag = false;

  predictions.forEach((pred) => {
    if (BAG_CLASSES.includes(pred.class) && pred.score > CONFIDENCE_THRESHOLD) {
      foundBag = true;
      const [x, y, w, h] = pred.bbox;

      ctx.strokeStyle = "orange";
      ctx.lineWidth = 3;
      ctx.strokeRect(x, y, w, h);
      ctx.fillStyle = "black";
      ctx.fillText(`${pred.class} ${(pred.score * 100).toFixed(1)}%`, x, y > 20 ? y - 5 : y + 20);

      if (pixelPerCm) {
        const widthCm = (w / pixelPerCm).toFixed(1);
        const heightCm = (h / pixelPerCm).toFixed(1);
        const isValid = widthCm <= 35 && heightCm <= 55;

        ctx.fillStyle = isValid ? "green" : "red";
        ctx.fillText(`~${widthCm}cm x ${heightCm}cm`, x + 5, y + h + 20);
        ctx.fillText(isValid ? "✅ Cabine OK" : "❌ Trop grand", x + 5, y + h + 40);
        statusEl.textContent = isValid
          ? `✅ Bagage détecté : ${widthCm}cm × ${heightCm}cm (OK)`
          : `🚫 Bagage trop grand : ${widthCm}cm × ${heightCm}cm`;
      } else {
        statusEl.textContent = "🕵️‍♂️ A4 non détectée, mesure impossible";
      }
    }
  });

  if (!foundBag) {
    statusEl.textContent = "❌ Aucun bagage détecté";
  }

  requestAnimationFrame(detectFrame);
}
