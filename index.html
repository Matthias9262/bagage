<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>D√©mo D√©tection Bagage OUIGO - Calibration Fixe</title>

<style>
  :root {
    --ouigo-rose: #ff3c9e;
    --ouigo-violet: #4b0082;
    --ouigo-jaune: #ffce00;
    --ouigo-bg: #f8f0ff;
    --ouigo-dark: #2a005f;
  }

  body {
    margin:0; padding:0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--ouigo-bg);
    color: var(--ouigo-dark);
    display:flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }

  header {
    background: var(--ouigo-rose);
    width: 100%;
    padding: 15px 10px;
    color: white;
    font-weight: 900;
    font-size: 1.8em;
    text-align: center;
    letter-spacing: 2px;
    box-shadow: 0 5px 15px rgba(255, 60, 158, 0.5);
    user-select: none;
  }

  #langToggle {
    position: fixed;
    top: 15px; left: 15px;
    background: var(--ouigo-violet);
    color: var(--ouigo-jaune);
    font-weight: 700;
    border-radius: 5px;
    border: none;
    padding: 7px 14px;
    cursor: pointer;
    box-shadow: 0 0 10px var(--ouigo-violet);
    transition: background 0.3s ease;
    z-index: 1000;
  }
  #langToggle:hover {
    background: var(--ouigo-jaune);
    color: var(--ouigo-violet);
  }

  main {
    flex-grow: 1;
    max-width: 480px;
    width: 100%;
    margin-top: 60px;
    padding: 0 10px 30px 10px;
    text-align: center;
    position: relative;
  }

  #video {
    width: 100%;
    max-height: 360px;
    border-radius: 12px;
    box-shadow: 0 0 25px var(--ouigo-rose);
    background: black;
  }

  canvas#overlay {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
  }

  #calibrationBox {
    position: absolute;
    border: 3px dashed var(--ouigo-jaune);
    width: 110px;
    height: 70px;
    top: 75px;
    left: calc(50% - 55px);
    border-radius: 14px;
    animation: pulseGlow 1.8s infinite ease-in-out;
    box-shadow: 0 0 20px var(--ouigo-jaune);
    pointer-events: none;
    z-index: 10;
    transition: opacity 0.6s ease;
  }

  #calibrationBox.hidden {
    opacity: 0;
    pointer-events: none;
  }

  @keyframes pulseGlow {
    0%, 100% { box-shadow: 0 0 20px var(--ouigo-jaune); }
    50% { box-shadow: 0 0 40px var(--ouigo-jaune); }
  }

  #instructions {
    font-weight: 600;
    margin: 8px 0 18px 0;
    color: var(--ouigo-violet);
    font-size: 1.1em;
  }

  button {
    background: var(--ouigo-rose);
    border: none;
    border-radius: 25px;
    color: white;
    font-weight: 700;
    font-size: 1.1em;
    padding: 14px 28px;
    margin: 12px 6px 30px 6px;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(255, 60, 158, 0.6);
    transition: background 0.25s ease;
    user-select: none;
  }
  button:hover {
    background: var(--ouigo-violet);
  }
  button:disabled {
    background: #ccc;
    cursor: not-allowed;
    box-shadow: none;
  }

  #feedback {
    margin-top: 10px;
    font-weight: 700;
    font-size: 1.2em;
    min-height: 28px;
    color: var(--ouigo-dark);
    user-select: none;
  }

  #confidenceBar {
    width: 100%;
    height: 14px;
    background: #ddd;
    border-radius: 8px;
    overflow: hidden;
    margin: 14px 0;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.15);
  }
  #confidenceFill {
    height: 100%;
    width: 0%;
    background: var(--ouigo-rose);
    transition: width 0.3s ease;
  }

  #bagageList {
    margin-top: 20px;
    max-height: 160px;
    overflow-y: auto;
    border: 2px solid var(--ouigo-rose);
    border-radius: 14px;
    padding: 10px;
    background: white;
    user-select: none;
  }

  #bagageList h2 {
    color: var(--ouigo-rose);
    margin-top: 0;
  }

  #bagageList ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  #bagageList li {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    font-weight: 600;
  }

  #bagageList img {
    width: 55px;
    height: 40px;
    object-fit: cover;
    border-radius: 8px;
    box-shadow: 0 0 8px var(--ouigo-rose);
    border: 1.5px solid var(--ouigo-violet);
  }

  .bagage-ok {
    color: var(--ouigo-rose);
  }

  .bagage-nok {
    color: #cc0033;
  }

  /* Confettis */
  #confetti {
    pointer-events: none;
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    z-index: 2000;
  }
</style>
</head>
<body>
<header>D√©mo D√©tection Bagage OUIGO ‚úàÔ∏èüß≥</header>

<button id="langToggle" aria-label="Changer la langue">FR</button>

<main>
  <div style="position:relative; width: 100%; max-width: 480px; margin: auto;">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
    <div id="calibrationBox" aria-label="Cadre de calibration carte bancaire"></div>
  </div>
  <div id="instructions" aria-live="polite" role="alert" data-lang="fr">Place ta carte bancaire dans le cadre jaune et clique sur "D√©marrer la d√©mo".</div>
  <div id="instructions" aria-live="polite" role="alert" data-lang="en" style="display:none;">Place your credit card inside the yellow box and click "Start demo".</div>
  
  <button id="btnStart">D√©marrer la d√©mo</button>
  <button id="btnReset" style="display:none;">R√©initialiser calibration</button>

  <div id="feedback" aria-live="polite" role="status"></div>
  <div id="confidenceBar" aria-label="Barre de confiance">
    <div id="confidenceFill"></div>
  </div>

  <div id="bagageList" aria-live="polite" role="log">
    <h2>Bagages d√©tect√©s</h2>
    <ul id="list"></ul>
  </div>
</main>

<canvas id="confetti"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.8.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<script>
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const ctx = overlay.getContext('2d');
  const calibrationBox = document.getElementById('calibrationBox');
  const instructions = document.querySelectorAll('#instructions');
  const btnStart = document.getElementById('btnStart');
  const btnReset = document.getElementById('btnReset');
  const feedback = document.getElementById('feedback');
  const confidenceFill = document.getElementById('confidenceFill');
  const bagageList = document.getElementById('list');
  const langToggle = document.getElementById('langToggle');
  const confettiCanvas = document.getElementById('confetti');
  const confettiCtx = confettiCanvas.getContext('2d');

  // Variables de calibration & d√©tection
  const realCardWidthCm = 8.5; // largeur carte bancaire standard
  let calibrationPxWidth = 0;
  let scalePxToCm = 0;
  let isCalibrated = false;
  let bboxHistory = [];
  const stableThreshold = 10;
  let detectionStableCount = 0;
  let model = null;
  let currentLang = 'fr';

  // Confettis
  let confettis = [];

  // Setup cam√©ra mobile / desktop
  async function setupCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment',
          width: { ideal: 640 },
          height: { ideal: 480 }
        },
        audio: false
      });
      video.srcObject = stream;
      await video.play();

      overlay.width = video.videoWidth;
      overlay.height = video.videoHeight;

      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
    } catch (e) {
      alert("Erreur acc√®s cam√©ra : " + e.message);
    }
  }

  // Chargement mod√®le coco-ssd
  async function loadModel() {
    model = await cocoSsd.load();
  }

  // Lissage bbox (moyenne mobile)
  function smoothBBox(history) {
    const len = history.length;
    if(len === 0) return [0,0,0,0];
    let sx=0, sy=0, sw=0, sh=0;
    for(let i=0; i<len; i++){
      sx += history[i][0];
      sy += history[i][1];
      sw += history[i][2];
      sh += history[i][3];
    }
    return [sx/len, sy/len, sw/len, sh/len];
  }

  // Dessin cadre avec glow & pulsation OUIGO
  let pulseOpacity = 0;
  function drawPulseRect(x,y,w,h,ok){
    ctx.clearRect(0,0,overlay.width, overlay.height);
    ctx.lineWidth = 6;
    ctx.strokeStyle = ok ? 'rgba(255,60,158,' + (0.6 + 0.4*Math.abs(Math.sin(pulseOpacity))) + ')' : 'rgba(204,0,51,' + (0.6 + 0.4*Math.abs(Math.sin(pulseOpacity))) + ')';
    ctx.shadowColor = ctx.strokeStyle;
    ctx.shadowBlur = 16;
    ctx.beginPath();
    ctx.roundRect(x,y,w,h,14);
    ctx.stroke();
    pulseOpacity += 0.07;
    if(pulseOpacity > Math.PI*2) pulseOpacity = 0;
  }

  CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
    if (w < 2 * r) r = w / 2;
    if (h < 2 * r) r = h / 2;
    this.beginPath();
    this.moveTo(x + r, y);
    this.arcTo(x + w, y, x + w, y + h, r);
    this.arcTo(x + w, y + h, x, y + h, r);
    this.arcTo(x, y + h, x, y, r);
    this.arcTo(x, y, x + w, y, r);
    this.closePath();
    return this;
  }

  // Barre confiance
  function setConfidenceBar(score){
    const pct = Math.min(1, Math.max(0, score)) * 100;
    confidenceFill.style.width = pct + '%';
  }

  // Message fun OUIGO
  function setMessageStatus(ok, lang){
    if(ok){
      feedback.innerHTML = lang==='fr' 
        ? 'üéâ Bagage conforme ! N\'oublie pas l\'option <strong>bagage suppl√©mentaire</strong> si tu en as plus d\'un ! üòâ'
        : 'üéâ Bag compliant! Don\'t forget the <strong>extra baggage option</strong> if you have more than one! üòâ';
      triggerConfetti();
    } else {
      feedback.innerHTML = lang==='fr' 
        ? '‚ö†Ô∏è Attention, bagage trop grand, pense √† v√©rifier ta r√©servation OUIGO !'
        : '‚ö†Ô∏è Warning, bag too big, please check your OUIGO booking!';
    }
  }

  // Suggestion texte
  function getSuggestion(ok, widthCm, lang){
    if(ok){
      return lang==='fr' 
        ? `Largeur estim√©e : <strong>${widthCm.toFixed(1)} cm</strong>. Parfait pour OUIGO !`
        : `Estimated width: <strong>${widthCm.toFixed(1)} cm</strong>. Perfect for OUIGO!`;
    } else {
      return lang==='fr' 
        ? `Largeur estim√©e : <strong>${widthCm.toFixed(1)} cm</strong>. Trop large pour OUIGO (max 55cm).`
        : `Estimated width: <strong>${widthCm.toFixed(1)} cm</strong>. Too big for OUIGO (max 55cm).`;
    }
  }

  // Conversion px -> cm (apr√®s calibration)
  function pxToCm(px) {
    return px * scalePxToCm;
  }

  // Capture image bagage
  function captureBagageImage([x,y,w,h]){
    const scaleX = video.videoWidth / video.clientWidth;
    const scaleY = video.videoHeight / video.clientHeight;

    const sx = x * scaleX;
    const sy = y * scaleY;
    const sw = w * scaleX;
    const sh = h * scaleY;

    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = sw;
    tempCanvas.height = sh;
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.drawImage(video, sx, sy, sw, sh, 0, 0, sw, sh);
    return tempCanvas.toDataURL('image/jpeg', 0.85);
  }

  // Ajoute bagage √† la liste
  function addBagageToList(imgUrl, widthCm, ok){
    const li = document.createElement('li');
    li.className = ok ? 'bagage-ok' : 'bagage-nok';
    li.innerHTML = `<img src="${imgUrl}" alt="Photo bagage d√©tect√©" /> <span>${widthCm.toFixed(1)} cm</span>`;
    bagageList.prepend(li);

    // Limiter la liste √† 10 √©l√©ments
    while(bagageList.childNodes.length > 10){
      bagageList.removeChild(bagageList.lastChild);
    }
  }

  // Synth√®se vocale voix f√©minine naturelle
  function speak(text){
    if(!window.speechSynthesis) return;
    const utterance = new SpeechSynthesisUtterance(text);
    const voices = window.speechSynthesis.getVoices();
    // Choix voix f√©minine fran√ßaise ou anglaise selon langue
    const voiceFr = voices.find(v => v.lang.startsWith('fr') && v.name.toLowerCase().includes('female'));
    const voiceEn = voices.find(v => v.lang.startsWith('en') && v.name.toLowerCase().includes('female'));
    utterance.voice = currentLang==='fr' ? (voiceFr || voices[0]) : (voiceEn || voices[0]);
    utterance.pitch = 1.1;
    utterance.rate = 1.0;
    window.speechSynthesis.speak(utterance);
  }

  // Confettis simples rose/violet OUIGO
  function triggerConfetti(){
    for(let i=0; i<30; i++){
      confettis.push({
        x: Math.random()*confettiCanvas.width,
        y: -10,
        size: 10 + Math.random()*10,
        speed: 2 + Math.random()*3,
        angle: Math.random()*Math.PI*2,
        spin: (Math.random()-0.5)*0.2,
        color: i % 2 === 0 ? 'var(--ouigo-rose)' : 'var(--ouigo-violet)'
      });
    }
  }
  function drawConfetti(){
    confettiCtx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
    for(let i=confettis.length-1; i>=0; i--){
      let c = confettis[i];
      c.y += c.speed;
      c.angle += c.spin;
      if(c.y > confettiCanvas.height){
        confettis.splice(i,1);
        continue;
      }
      confettiCtx.save();
      confettiCtx.translate(c.x,c.y);
      confettiCtx.rotate(c.angle);
      confettiCtx.fillStyle = c.color;
      confettiCtx.fillRect(-c.size/2,-c.size/2,c.size,c.size*0.3);
      confettiCtx.restore();
    }
    requestAnimationFrame(drawConfetti);
  }
  drawConfetti();

  // Changement langue FR/EN
  langToggle.addEventListener('click', () => {
    currentLang = currentLang==='fr' ? 'en' : 'fr';
    langToggle.textContent = currentLang.toUpperCase();
    instructions.forEach(el => {
      el.style.display = (el.dataset.lang === currentLang ? 'block' : 'none');
    });
    feedback.textContent = '';
  });

  // Bouton d√©marrer d√©mo
  btnStart.addEventListener('click', () => {
    if(!isCalibrated){
      calibrate();
    }
    if(!isCalibrated){
      alert(currentLang==='fr' ? 'Place ta carte dans le cadre jaune puis clique sur "D√©marrer la d√©mo".' : 'Place your card inside the yellow box then click "Start demo".');
      return;
    }
    // Cacher cadre jaune d√®s que calibr√©
    calibrationBox.classList.add('hidden');

    btnStart.disabled = true;
    btnReset.style.display = 'inline-block';
    feedback.textContent = currentLang==='fr' ? 'D√©tection en cours...' : 'Detecting...';
    detectFrame();
  });

  // Bouton reset calibration
  btnReset.addEventListener('click', () => {
    isCalibrated = false;
    calibrationPxWidth = 0;
    scalePxToCm = 0;
    bboxHistory = [];
    detectionStableCount = 0;
    btnReset.style.display = 'none';
    btnStart.disabled = false;
    feedback.textContent = currentLang==='fr' ? 'Calibration r√©initialis√©e. Place ta carte dans le cadre jaune.' : 'Calibration reset. Place your card inside the yellow box.';
    calibrationBox.classList.remove('hidden');
  });

  // Calibration simplifi√©e : mesure du cadre fixe en pixels dans la vid√©o
  function calibrate() {
    const boxRect = calibrationBox.getBoundingClientRect();
    const videoRect = video.getBoundingClientRect();

    calibrationPxWidth = boxRect.width * (video.videoWidth / videoRect.width);
    scalePxToCm = realCardWidthCm / calibrationPxWidth;

    isCalibrated = true;
    feedback.textContent = currentLang==='fr' ? 'Calibration OK ! Place ton bagage devant la cam√©ra.' : 'Calibration OK! Place your bag in front of the camera.';
  }

  // Boucle d√©tection + affichage
  async function detectFrame(){
    if(!model){
      feedback.textContent = currentLang==='fr' ? 'Chargement mod√®le...' : 'Loading model...';
      await loadModel();
    }

    model.detect(video).then(predictions => {
      ctx.clearRect(0, 0, overlay.width, overlay.height);

      // Filtre valises/sacs
      const bagages = predictions.filter(p => ['suitcase','backpack','handbag'].includes(p.class));

      if(bagages.length === 0){
        feedback.textContent = currentLang==='fr' ? 'Pas de bagage d√©tect√© üòï' : 'No baggage detected üòï';
        confidenceFill.style.width = '0%';
        detectionStableCount = 0;
        requestAnimationFrame(detectFrame);
        return;
      }

      // Meilleure confiance
      const best = bagages.reduce((a,b) => a.score > b.score ? a : b);

      // Lissage bbox historique
      bboxHistory.push([best.bbox[0], best.bbox[1], best.bbox[2], best.bbox[3]]);
      if(bboxHistory.length > stableThreshold) bboxHistory.shift();

      const [x,y,w,h] = smoothBBox(bboxHistory);

      // Largeur estim√©e en cm
      const widthCm = pxToCm(w);

      // V√©rif largeur max OUIGO 55cm
      const isOk = widthCm <= 55;

      // Dessin cadre pulsant OUIGO
      drawPulseRect(x,y,w,h,isOk);

      // Barre confiance
      setConfidenceBar(best.score);

      // Message + voix
      setMessageStatus(isOk, currentLang);
      feedback.insertAdjacentHTML('beforeend', `<br><small>${getSuggestion(isOk, widthCm, currentLang)}</small>`);

      if(detectionStableCount === 0 && best.score > 0.7){
        speak(feedback.textContent);
      }
      if(best.score > 0.7){
        detectionStableCount++;
      } else {
        detectionStableCount = 0;
      }

      // Capture image bagage tous les 50 frames stables
      if(detectionStableCount === 50){
        const imgData = captureBagageImage([x,y,w,h]);
        addBagageToList(imgData, widthCm, isOk);
        detectionStableCount = 0;
      }

      requestAnimationFrame(detectFrame);
    });
  }

  // Setup initial
  setupCamera().then(() => {
    feedback.textContent = 'Place ta carte bancaire dans le cadre jaune pour calibrer.';
  });
</script>
</body>
</html>
